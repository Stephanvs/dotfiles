set-environment -gF TMUX_PLUGIN_MANAGER_PATH '#{HOME}/.tmux/plugins/'

if 'test ! -d "${TMUX_PLUGIN_MANAGER_PATH}/tpm"' {
  run 'mkdir -p "${TMUX_PLUGIN_MANAGER_PATH}"'
  run 'git clone https://github.com/tmux-plugins/tpm "${TMUX_PLUGIN_MANAGER_PATH}/tpm"'
  run '${TMUX_PLUGIN_MANAGER_PATH}/tpm/bin/install_plugins'
}

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'sunaku/tmux-navigate'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'wfxr/tmux-fzf-url'
set -g @plugin 'alexwforsythe/tmux-which-key'
set -g @plugin 'fabioluciano/tmux-powerkit'

# Extended keys support (useful for Neovim/Vim)
set-option -g extended-keys on
set-option -as terminal-features ',*:extkeys'

# Undercurl/underline support (for LSP diagnostics in Neovim)
set-option -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set-option -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

########################
# POWERKIT CONFIGURATION
########################

# set -g @powerkit_theme "tokyo-night"
# set -g @powerkit_theme_variant "night"
set -g @powerkit_theme "catppuccin"
set -g @powerkit_theme_variant "mocha"
set -g @powerkit_transparent "true"

set -g @powerkit_status_order "session,plugins,windows"
set -g @powerkit_elements_spacing "false"
set -g @powerkit_window_index_style "box"
set -g @powerkit_window_index_icons "true"
set -g @powerkit_edge_separator_style "rounded:all"

set -g @powerkit_theme_selector_key "T"

set -g @powerkit_pane_flash_enabled "true"
set -g @powerkit_pane_flash_duration "100"

# Status bar position and update interval
set -g @powerkit_status_position "top"
set -g @powerkit_status_interval "5"
set -g @powerkit_status_order "session,plugins,windows"

# Lazy loading for performance
set -g @powerkit_lazy_loading "true"
set -g @powerkit_stale_multiplier "3"

# -----------------------------------------------------------------------------
#  Plugins Selection
# -----------------------------------------------------------------------------
# Groups:
#   Blue:   System     - cpu, memory, disk, gpu, temperature, fan, iops
#   Purple: Network    - netspeed, wifi, vpn, ssh
#   Green:  VCS        - git, github, bitbucket
#   Yellow: DevOps     - jira, kubernetes, terraform
#   Red:    Media      - audiodevices, nowplaying, bluetooth
#   None:   Standalone - weather, camera, microphone, battery, bitwarden, etc.

set -g @powerkit_plugins "\
weather,\
group(cpu,memory,disk,gpu,temperature,fan,iops),\
group(netspeed,wifi,vpn,ssh),\
group(git,github),\
# group(jira,kubernetes,terraform),\
group(audiodevices,nowplaying,bluetooth),\
camera,microphone,battery,hostname"
# camera,microphone,battery,bitwarden,cloudstatus,packages,smartkey"

# -----------------------------------------------------------------------------
#  Show Only on Threshold (hide plugins when values are normal)
# -----------------------------------------------------------------------------
set -g @powerkit_plugin_battery_show_only_on_threshold "true"
set -g @powerkit_plugin_cpu_show_only_on_threshold "true"
set -g @powerkit_plugin_memory_show_only_on_threshold "true"
set -g @powerkit_plugin_disk_show_only_on_threshold "true"
set -g @powerkit_plugin_gpu_show_only_on_threshold "true"
set -g @powerkit_plugin_temperature_show_only_on_threshold "true"
set -g @powerkit_plugin_fan_show_only_on_threshold "true"
set -g @powerkit_plugin_iops_show_only_on_threshold "true"
set -g @powerkit_plugin_ping_show_only_on_threshold "true"
set -g @powerkit_plugin_wifi_show_only_on_threshold "true"
set -g @powerkit_plugin_git_show_only_on_threshold "true"
set -g @powerkit_plugin_github_show_only_on_threshold "true"

# -----------------------------------------------------------------------------
#  Plugin: Weather
# -----------------------------------------------------------------------------
set -g @powerkit_plugin_weather_location "Eindhoven,Netherlands"
set -g @powerkit_plugin_weather_format "%t H:%h"
set -g @powerkit_plugin_weather_icon_mode "dynamic"

# # -----------------------------------------------------------------------------
# #  Plugin: Bitbucket
# # -----------------------------------------------------------------------------
# set -g @powerkit_plugin_bitbucket_type "cloud"
# set -g @powerkit_plugin_bitbucket_repos "fabioluciano/testea"
# set -g @powerkit_plugin_bitbucket_email "stephan.van.stekelenburg@prosim-ar.com"
# set -g @powerkit_plugin_bitbucket_token "$BITBUCKET_TOKEN"

# -----------------------------------------------------------------------------
#  Plugin: GitHub
# -----------------------------------------------------------------------------
set -g @powerkit_plugin_github_repos "stephanvs/tmux-powerkit"
set -g @powerkit_plugin_github_token "$GITHUB_TOKEN"
set -g @powerkit_plugin_github_warning_threshold_issues "1"
set -g @powerkit_plugin_github_warning_threshold_prs "1"

# -----------------------------------------------------------------------------
#  Plugin: Fan
# -----------------------------------------------------------------------------
set -g @powerkit_plugin_fan_selection "active"

# -----------------------------------------------------------------------------
#  Plugin: AudioDevices
# -----------------------------------------------------------------------------
set -g @powerkit_plugin_audiodevices_display_mode "off"
set -g @powerkit_plugin_audiodevices_keybinding_input "M-i"
set -g @powerkit_plugin_audiodevices_keybinding_output "M-o"

# -----------------------------------------------------------------------------
#  Plugin: NowPlaying
# -----------------------------------------------------------------------------
set -g @powerkit_plugin_nowplaying_info_when_paused "true"

# # DateTime (matching your previous format: %d.%m. %H:%M)
set -g @powerkit_plugin_datetime_format "%d.%m. %H:%M"
set -g @powerkit_plugin_datetime_icon ""

# Pomodoro (replaces olimorris/tmux-pomodoro-plus)
set -g @powerkit_plugin_pomodoro_work_duration "25"
set -g @powerkit_plugin_pomodoro_break_duration "5"






# ----- TERMINAL SETTINGS -----
set -g default-terminal 'screen-256color'
set -ag terminal-overrides ',xterm-256color*:RGB'

# Status bar position (set directly in addition to powerkit option)
set -g status-position top

set -g allow-rename off
set -s escape-time 0

# -----------------------------------------------------------------------------
#  Better Mouse Mode Settings
# -----------------------------------------------------------------------------
set -g mouse on
set -g @scroll-without-changing-pane 'on'
set -g @scroll-in-moused-over-pane 'on'
set -g @emulate-scroll-for-no-mouse-alternate-buffer 'on'
set -g @scroll-speed-num-lines-per-scroll '3'

# Start window and pane numbering at 1
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on   # Renumber windows when one is closed

# Window behavior
set-window-option -g automatic-rename on
set-window-option -g pane-base-index 1

# Allow a little longer key repeat time (1s, default 500ms)
set -g repeat-time 1000

# Scrollback buffer
set -g history-limit 50000
set -g display-time 2000

# ===========
# KEYBINDINGS
# ===========

# Easy config reload
bind C-r source-file $DOTFILES/tmux/tmux.conf \; display-message "Config reloaded!"

# Open new windows in current working directory
bind c new-window -c "#{pane_current_path}"

# Split panes using - and | with current path
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Quick window/session switching
# bind Space last-window              # prefix + Space: last window
bind -r Tab switch-client -l        # prefix + Tab: last session

# Vim-like pane resizing (with prefix)
bind -r M-k resize-pane -U
bind -r M-j resize-pane -D
bind -r M-h resize-pane -L
bind -r M-l resize-pane -R

# Alt+Shift+Arrow pane resizing (no prefix)
bind -n M-S-Left resize-pane -L 2
bind -n M-S-Right resize-pane -R 2
bind -n M-S-Up resize-pane -U 1
bind -n M-S-Down resize-pane -D 1

# Vim-like pane switching (with prefix)
bind -r k select-pane -U
bind -r j select-pane -D
bind -r h select-pane -L
bind -r l select-pane -R

# Alt+number window switching (no prefix)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9
bind -n M-0 select-window -t 10
bind -n M-\` previous-window

# Unbind arrow keys for pane selection
unbind Up
unbind Down
unbind Left
unbind Right

# Copy mode (vim-style)
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# ===================================
# SESSION MANAGEMENT (sesh + gum/fzf)
# ===================================

# Quick session picker with gum
bind-key C-j display-popup -E -w 40% "sesh connect \"$(
    sesh list -i | gum filter --limit 1 --placeholder 'Choose a session' --height 50 --prompt='‚ö°'
)\""

# Advanced session picker with fzf
bind-key C-k display-popup -w 60% -h 55% -E "sesh connect \"$(
    sesh list | fzf -- \
        --no-sort --border-label ' sesh ' --prompt '‚ö°  ' \
        --header '  ^a=all | ^t=tmux | ^x=zoxide | ^g=config | ^d=tmux kill | ^f=find' \
        --bind 'tab:down,btab:up' \
        --bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list)' \
        --bind 'ctrl-t:change-prompt(üê†  )+reload(sesh list -t)' \
        --bind 'ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -c)' \
        --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z)' \
        --bind 'ctrl-f:change-prompt(üëÄ  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
        --bind 'ctrl-d:execute(tmux kill-session -t {})+change-prompt(‚ö°  )+reload(sesh list)'
)\""

# Create new named session
bind C-n display-popup \
  -E '$SHELL -i -c "name=$(gum input --placeholder "Session name: ") && tmux new-session -d -s \$name && tmux switch-client -t \$name"'

# ===============
# POPUP UTILITIES
# ===============

# Terminal popup
bind C-t display-popup \
  -d "#{pane_current_path}" \
  -w 75% \
  -h 75% \
  -E "zsh"

# Lazygit popup
bind C-g display-popup \
  -d "#{pane_current_path}" \
  -w 80% \
  -h 80% \
  -E "lazygit"

# Yazi file manager popup
bind C-f display-popup \
  -d "#{pane_current_path}" \
  -w 80% \
  -h 80% \
  -E "yazi"

# Opencode popup
bind C-o display-popup \
  -d "#{pane_current_path}" \
  -w 80% \
  -h 80% \
  -E "opencode"

# AI tools launch menu
bind o display-menu -T " Launch AI " \
    "opencode" "o" "split-window -h -c '#{pane_current_path}' 'opencode'; resize-pane -x 35%" \
    "claude-code" "c" "split-window -h -c '#{pane_current_path}' 'claude'; resize-pane -x 35%" \
    "gemini-cli" "g" "split-window -h -c '#{pane_current_path}' 'gemini'; resize-pane -x 35%" \
    "codex" "x" "split-window -h -c '#{pane_current_path}' 'codex'; resize-pane -x 35%"

# ==============================
# TPM PLUGIN MANAGEMENT BINDINGS
# ============================================================

# Switch to TPM bindings mode: prefix + g
bind-key -N 'Switch to plugin bindings' -T prefix 'g' {
  switch-client -T tpm-bindings
  display-message -d 1000 '#{E:log_info} in tpm-bindings mode'
}

bind-key -N 'Reload tmux configuration' -T tpm-bindings  'r' reload-config

bind-key -N 'TPM - Install plugins' -T tpm-bindings  'i' {
  display-message -d 1000 '#{E:log_info} Installing plugins... '
  run-shell '#{TMUX_PLUGIN_MANAGER_PATH}/tpm/bindings/install_plugins'
}

bind-key -N 'TPM - Update plugins' -T tpm-bindings  'u' {
  display-message -d 1000 '#{E:log_info} Updating plugins... '
  run-shell '#{TMUX_PLUGIN_MANAGER_PATH}/tpm/bindings/update_plugins'
}

bind-key -N 'TPM - Clean plugins' -T tpm-bindings  'x' {
  display-message -d 1000 '#{E:log_info} Cleaning plugins... '
  run-shell '#{TMUX_PLUGIN_MANAGER_PATH}/tpm/bindings/clean_plugins'
}

# Delete unneeded key bindings
unbind-key -a -T copy-mode

# Delete old TPM key bindings (now using prefix + g)
unbind-key -T prefix I
unbind-key -T prefix U

# ============================================================
# Initialize TPM (MUST BE AT THE END)
# ============================================================
run -b '#{TMUX_PLUGIN_MANAGER_PATH}/tpm/tpm'
